# Уровни переопределения

Обновлять библиотеки, разделять код проекта по платформам, создавать разные дизайны сайта, проводить эксперименты в рабочем проекте и при этом не ломать рабочий проект и не копировать код из одного проекта в другой. В БЭМ-методологии эти задачи решают уровни переопределения.

Уровень переопределения — это директория, которая содержит файлы реализаций [блоков](../key-concepts/key-concepts.ru.md#Блок), [элементов](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторов](../key-concepts/key-concepts.ru.md#Модификатор) (например, `block.css`, `block.js`).

* [Зачем нужны](#Зачем-нужны-уровни-переопределения)
* [Как использовать](#Как-использовать-уровни-переопределения)
* [Что дают](#Что-дают-уровни-переопределения)

Любой БЭМ-проект состоит минимум из одного уровня переопределения.

```files
project/
    level/                              # уровень переопределения
        block1/                         
            __elem1/                    
                block1__elem1.js        # файл реализации элемента elem1 блока block1 в технологии JavaScript
            _mod1/                      
                block1_mod1.css         # файл реализации модификатора mod1 блока block1 в технологии CSS
            block1.css                  # файл реализации блока block1 в технологии CSS
            block1.js                   # файл реализации блока block1 в технологии JavaScript
        block2/                         
            block2.css                  # файл реализации блока block2 в технологии CSS
            block2.js                   # файл реализации блока block1 в технологии JavaScript
        block3/
        block4/
```

> [Принципы организации файловой структуры БЭМ-проекта](../filestructure/filestructure.ru.md)

## Зачем нужны уровни переопределения

Уровни переопределения дают возможность:

* [Изменять (расширять или перекрывать) исходную реализацию](#Изменение-реализации-блока) БЭМ-сущностей без дублирования кода.
* [Подключать в проект дополнительные БЭМ-сущности](#Подключение-дополнительных-БЭМ-сущностей) (например, готовые блоки из сторонней библиотеки).

### Изменение реализации блока

В БЭМ-методологии реализация блока распределена по отдельным файлам технологий (`button.css`, `button.js`) — исходным файлам. Реализация блока в любой из технологий (например, `.css`) может быть разделена по разным уровням переопределения. Каждый дополнительный уровень может добавлять новые свойства блоку (доопределять, наследовать) или изменять старые (переопределять).

Финальная реализация блока собирается со всех уровней последовательно в указанном порядке. Чтобы получить желаемый конечный результат блока, в настройках сборщика необходимо указать, с каких уровней и в каком порядке собирать исходные файлы. Количество уровней и порядок их подключения может быть любым.

> **Аналогия** Уровни переопределения ведут себя как слои в графическом редакторе: базовый слой – это исходная реализация блока, а каждый последующий слой накладывается сверху и дополняет (наследует) или изменяет базовую реализацию.

![Уровни переопределения](../key-concepts/key-concepts__levels.png)

Пример переопределения CSS-свойств блока:

```files
project/
    common/                # уровень переопределения common
        button/
            button.css
            button.js
    project/               # уровень переопределения project
        button/
            button.css
```

CSS-реализация

```css
/* Блок button в технологии CSS на уровне common */

.button {
    color: red;
    height: 24px;
}

/* Блок button в технологии CSS на уровне project */

.button {
    color: green;
    font-size: 11px;
}
```

В результате сборки: 
* переопределятся повторяющиеся свойства (`color`) для блока `button` (кнопка из красной превратится в зеленую);
* добавится новое свойство (`font-size`). 

```css
@import "common/button/button.css";    /* Базовые CSS-правила */
@import "project/button/button.css";   /* Особенности с уровня project */
```

В браузере для блока `button` применится следующий набор свойств:

```css
.button {
    color: green;
    height: 24px;
    font-size: 11px;
}
```

> **Важно** Можно переопределять не только CSS-свойства блока, но и его [методы](https://ru.bem.info/methodology/js/#Работа-с-уровнями-переопределения) и шаблоны.  
В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробности в разделе [Платформа](https://ru.bem.info/platform/bem-xjst/runtime/).

### Подключение дополнительных БЭМ-сущностей

С помощью уровней переопределения можно не только [изменять](#Изменение-реализации-блока) уже существующие БЭМ-сущности, но и добавлять новые. 

Рассмотрим пример, в котором добавим блоки с дополнительного уровня переопределения в проект. 

```files
project/
    common/                             # уровень переопределения common, блоки проекта
        button/
            button.css
            button.js
    blocks/                             # уровень переопределения blocks, дополнительная библиотека
        logo/                           # блок logo 
            logo.css                    # реализация блока logo в технологии CSS
```

Чтобы блок `logo` с уровня `blocks` попал в сборку, необходимо:

* указать блок `logo` в описании блоков, которые используются в построении страницы;
* подключить уровень переопределения `blocks` в настройках сборщика. 

```css
@import "common/button/button.css";     /* CSS-правила блока button */
@import "blocks/logo/logo.css";         /* CSS-правила блока logo */
```

> Аналогичным способом можно добавлять элементы и модификаторы любому блоку. Дополнительные элементы и модификаторы могут изменить внешний вид или поведение базового блока. 

## Как использовать уровни переопределения

Уровни переопределения позволяют организовать архитектуру проекта, чтобы:

* [Подключать библиотеки](#Проект-и-библиотеки) и обновлять их, не делая правок в коде.
* [Выделять общие части реализаций блоков](#Изменения-в-типовых-проектах) на один уровень, а частные случаи (например, специфическую реализацию для отдельных сервисов) — на другой.
* [Разделять проект на платформы](#Разделение-проекта-на-платформы). Общую реализацию для всех платформ хранить на одном уровне, а платформо-специфичную — выносить на другой.
* [Экспериментировать](#Проект-и-эксперименты) в рабочем проекте.
* [Иметь разные дизайны проекта](#Проект-и-дизайн).

### Проект и библиотеки

Библиотека подключается в БЭМ-проект как отдельный уровень. Изменять (до- или переопределять) блоки из этой библиотеки под требования проекта необходимо на другом уровне. При сборке следует подключать исходную реализацию блоков с уровня библиотеки и измененную — с уровня проекта.

Когда выйдет новая версия библиотеки, обновление не затронет изменения блоков для проекта, так как библиотека находится на одном уровне переопределения, а специфические реализации (доработки) блоков — на другом.

Рассмотрим на примере:

```files
project/
    library.blocks/
        button/
            button.css    # CSS-реализация кнопки в библиотеке (высота 20px)

    project.blocks/
        button/
            button.css    # переопределение на уровне проекта (высота 24px)
```

Если в новой версии библиотеки изменится высота кнопок (например, станет 18px), после обновления в проекте для блока `button` в браузере все равно применится переопределенное правило — 24px.

> Разделение по уровням переопределения позволяет сохранить изменения в блоках при обновлении библиотеки. 

### Разработка одного проекта на основе другого

Чтобы создать новый сайт на базе существующего или добавить похожую по структуре страницу для портала, можно скопировать общую часть кода и затем добавить специфичные реализации. А можно использовать уровни переопределения и хранить общий код на одном уровне, а специфику каждой страницы или каждого сайта — на других уровнях.

Что дают уровни в этом случае:
* нет необходимости копировать общую часть кода из проекта в проект;
* исправить ошибку в общем коде нужно один раз, правки применятся во все проекты;
* всегда можно переопределить часть общего кода под новые требования заказчика.


```files
project/                            
    blocks/                         # общие блоки для всего портала
        head/
            head.css
            head.js
        foot/
            foot.css
        sidebar/
            sidebar.css
            sidebar.js
    pages/                          # специфика реализации для отдельных страниц
        index/
            head/
                head.css            # изменение шрифта в шапке на заглавной странице
        about/
            about-text/             # добавление нового блока
                about-text.css
```

### Разделение проекта на платформы

Проект, поддерживающий разные платформы (например, `mobile` и `desktop`), всегда имеет общую функциональность и платформо-специфичную. Чтобы не копировать общую часть кода для реализации каждой из платформ, используются уровни переопределения: 

* common — общая реализация блоков для всех платформ;
* desktop — специфическая реализация блоков для настольных устройств;
* mobile — специфическая реализация блоков для мобильных устройств.

Рассмотрим на примере:

```files
project/
    common.blocks/
        button/
            button.css    # базовая CSS-реализация кнопки

    desktop.blocks/   
        button/
            button.css    # особенности кнопки для настольных устройств

    mobile.blocks/
        button/
            button.css    # особенности кнопки для мобильных устройств
```

При сборке в файл `desktop.css` попадут все базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `desktop`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "desktop.blocks/button/button.css";   /* Особенности desktop */
```

Файл `mobile.css` будет включать базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `mobile`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "mobile.blocks/button/button.css";    /* Особенности mobile */
```

### Проект и эксперименты

Уровни переопределения позволяют проводить A/B тестирование непосредственно в рабочем проекте. При этом существующий код проекта менять не нужно. 

Рассмотрим пример, когда проект уже запущен, а заказчик хочет внести изменения. Например, предлагает разные варианты отображения личного фото пользователей. Разработчик должен изменить все фотографии всех пользователей на всех страницах сайта, провести тестирование и выбрать наиболее подходящий вариант. 

В большинстве проектов без уровней переопределения необходимо:
* найти все случаи использования блока `user-pic` на каждой странице (предположим, что блок встречается на странице 15 раз, а страниц на сайте +100500) 
* написать для каждого случая условие проверки (`if`);  
    ```
      if (пользователь попал в эксперимент 'круг')
      {
      отобрази фотографии пользователей в круглыми;
      };
      if (пользователь попал в эксперимент 'квадрат')
      {
      отобрази фотографии пользователей в квадратными;
      };
    ```

* выбрать финальный вариант;
* возможно, понять, что ни один вариант не подходит, и продолжить эксперименты с новыми вариантами;
* удалить изменения для каждого случая на каждой странице;
* применить выбранные изменения для каждого случая.

Чтобы провести такое тестирование в БЭМ-проекте достаточно создать отдельный уровень переопределения для каждого эксперимента.

```files
project/                    
    blocks/                 # блоки проекта
        user-pic/           # блок `user-pic`
        ...
    tests/
        test-circle/        # уровень для эксперимента 'круг'
            user-pic/       # блок `user-pic` с измененными круглыми фотографиями 
        test-square/        # уровень для эксперимента 'квадрат'
            user-pic/       # блок `user-pic` с измененными квадратными фотографиями  
        test-n/             # уровень для любого нового эксперимента
            user-pic/       # блок `user-pic` с любыми новыми изменениями
```

Во время экспериментов код рабочего проекта не изменяется. 

Чтобы убрать из проекта неподходящий вариант, достаточно удалить директорию — уровень переопределения неудачного эксперимента.

> Так же можно проводить эксперименты, меняя поведение блока или разметку страницы. Например, если необходимо добавить новые теги для обеспечения доступности сайта (a11y). В этом случае переопределяются шаблоны и JavaScript-код.

### Проект и дизайн

Поведение и внешний вид проекта можно разделить на разные уровни переопределения. Бизнес-логика не меняется в зависимости от переключения дизайна, поэтому находится на отдельном уровне (`common`). Код, отвечающий за внешний вид проекта, вынесен на уровень дизайна (`design`).

```files
common/             # бизнес-логика проекта
    button/
    input/
    ...
design/             # внешний вид проекта
    alfa/           # дизайн проекта alfa
        button/
        input/
    beta/           # дизайн проекта beta
        button/
        input/
```

Для добавления нового дизайна необходимо создать дополнительный уровень переопределения, пере- или доопределить существующие блоки и включить данный уровень в сборку.

## Что дают уровни переопределения

Уровни переопределения позволяют:

* Избавится от дублирования кода — выделить общую часть кода и подключать как отдельный уровень.
* Не плодить новые сущности, если необходимо изменить функциональность существующего блока (пере- и доопределение).
* Сократить время на отладку проекта — исправить ошибку в общем коде нужно один раз, правки применятся во все проекты.
* Организовать архитектуру проекта, чтобы [ускорить разработку, поддержку и эксперименты](#Как-использовать-уровни-переопределения). 
